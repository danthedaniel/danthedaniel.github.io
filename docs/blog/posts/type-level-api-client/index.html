<!DOCTYPE html>


<html lang="en-us" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>Type-Level API Client - danangell.com/blog</title>

<meta name="description" content="One year ago I looked around for existing tech that would provide me with compile-time guarantees for a REST-ish API interface. With full-stack TypeScript web applications reaching a level of maturity where I, a previously die-hard Rails developer, felt comfortable taking the dive - it seemed like the Node ecosystem was lacking in ties between the front end and back end.">





<link rel="icon" type="image/x-icon" href="https://danangell.com/blog/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://danangell.com/blog/favicon.png">


<style>
  body {
    visibility: hidden;
    opacity: 0;
  }
</style>

<noscript>
  <style>
    body {
      visibility: visible;
      opacity: 1;
    }
  </style>
</noscript>



    





    
    
        
    
    

    
        <link rel="stylesheet" href="https://danangell.com/blog/css/style.min.ca709c0968724ee5b61f89cb70717523fe842586488c76f4aadcc9bfa7ae4abb.css" integrity="sha256-ynCcCWhyTuW2H4nLcHF1I/6EJYZIjHb0qtzJv6euSrs=">
    





    

    





    
    
        
    
    

    
        <script src="https://danangell.com/blog/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js" type="text/javascript" charset="utf-8" integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script>
    







    





    
        <script src="https://danangell.com/blog/js/katex_auto.js?rnd=1681948078" type="text/javascript" charset="utf-8"></script>
    



<meta property="og:title" content="Type-Level API Client" />
<meta property="og:description" content="One year ago I looked around for existing tech that would provide me with compile-time guarantees for a REST-ish API interface. With full-stack TypeScript web applications reaching a level of maturity where I, a previously die-hard Rails developer, felt comfortable taking the dive - it seemed like the Node ecosystem was lacking in ties between the front end and back end." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://danangell.com/blog/posts/type-level-api-client/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-14T14:55:04-07:00" />
<meta property="article:modified_time" content="2022-05-14T14:55:04-07:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Type-Level API Client"/>
<meta name="twitter:description" content="One year ago I looked around for existing tech that would provide me with compile-time guarantees for a REST-ish API interface. With full-stack TypeScript web applications reaching a level of maturity where I, a previously die-hard Rails developer, felt comfortable taking the dive - it seemed like the Node ecosystem was lacking in ties between the front end and back end."/>









<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.8.2/katex.min.css"
  integrity="sha384-XFgyVzCwumZgSg6F85gbh6ev/BVWgP7QAb1V3GOchWQPifusZTU0ODnQsysBK61F" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.8.2/katex.min.js"
  integrity="sha384-RpxfKy6OA0Us+WtIGBbrVlfwW4HuETdB9CD8KbG6qSbYbCanfnyid62sojNvydoB" crossorigin="anonymous"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&family=Roboto+Mono&display=swap">

    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <div class="header-top">
    <h1 class="site-title">
        <a href="/blog">danangell.com/blog</a>
    </h1>
    <a href="/blog/about">about</a>
    <div>
        <ul class="social-icons">

    
    
    
    
    <li>
        <a href="https://github.com/danthedaniel" title="Github" rel="me">
            <span class="inline-svg" >




    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

</span>

        </a>
    </li>
    
    
    
    
    
    <li>
        <a href="https://www.linkedin.com/in/daniel-angell" title="Linkedin" rel="me">
            <span class="inline-svg" >




    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

</span>

        </a>
    </li>
    
    

    
</ul>
        





<button class="theme-switcher">
    <img src="/blog/image/dark-mode.svg" />
</button>


<script>
    const STORAGE_KEY = 'user-color-scheme'
    const defaultTheme = "auto"

    let currentTheme
    let switchButton
    let autoDefinedScheme = window.matchMedia('(prefers-color-scheme: dark)')

    const autoChangeScheme = e => {
        currentTheme = e.matches ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', currentTheme)
        changeButtonImage()
    }

    document.addEventListener('DOMContentLoaded', function () {
        switchButton = document.querySelector('.theme-switcher')
        currentTheme = detectCurrentScheme()
        if (currentTheme == 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark')
        }
        if (currentTheme == 'auto') {
            autoChangeScheme(autoDefinedScheme);
            autoDefinedScheme.addListener(autoChangeScheme);
        }

        if (switchButton) {
            changeButtonImage()
            switchButton.addEventListener('click', switchTheme, false)
        }

        showContent()
    })

    function detectCurrentScheme() {
        if (localStorage.getItem(STORAGE_KEY)) {
            return localStorage.getItem(STORAGE_KEY)
        }
        if (defaultTheme) {
            return defaultTheme
        }
        if (!window.matchMedia) {
            return 'light'
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark'
        }
        return 'light'
    }

    function changeButtonImage() {
        if (switchButton) {
            switchButton.innerHTML = currentTheme == 'dark' ? '<img src="/blog/image/light-mode.svg" />' : '<img src="/blog/image/dark-mode.svg" />';
        }
    }

    function switchTheme(e) {
        if (currentTheme == 'dark') {
            localStorage.setItem(STORAGE_KEY, 'light')
            document.documentElement.setAttribute('data-theme', 'light')
            currentTheme = 'light'
        } else {
            localStorage.setItem(STORAGE_KEY, 'dark')
            document.documentElement.setAttribute('data-theme', 'dark')
            currentTheme = 'dark'
        }
        changeButtonImage()
    }

    function showContent() {
        document.body.style.visibility = 'visible';
        document.body.style.opacity = 1;
    }
</script>
    </div>
</div>


            
        </header>
        <main id="main" tabindex="-1"> 
            
    

    <article class="post h-entry">
        <div class="post-header">
            <header>
                <h1 class="p-name post-title">Type-Level API Client</h1>

                
            </header>
        </div>
        <div class="content e-content">
            <p>One year ago I looked around for existing tech that would provide me with compile-time guarantees for a REST-ish API interface. With full-stack TypeScript web applications reaching a level of maturity where I, a previously die-hard Rails developer, felt comfortable taking the dive - it seemed like the Node ecosystem was lacking in ties between the front end and back end.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Has anyone made a purely type-level TypeScript API client yet? Seems like full stack TypeScript apps should just allow for a type import into the front end which would validate paths, verbs, body and response. No swagger or intermediary needed.</p>&mdash; Daniel Angell (@dan_the_daniel) <a href="https://twitter.com/dan_the_daniel/status/1387632537061580802">April 29, 2021</a></blockquote>
<p>As a minimalist, I was hoping for a solution that did not involve any extra dependencies. TypeScript alone seemed like a powerful enough tool to get the job done. Maybe I didn&rsquo;t look hard enough but I didn&rsquo;t end up finding prior art that I was happy with. Everything seemed to require either a very opinionated architecture, an intermediary file with its own build step, or a special HTTP client library. I&rsquo;d already learned not to trust the Node ecosystem and wanted the most unimpressive solution to get the job done. So I built my own.</p>
<h2 id="setting-expectations" >Setting expectations
<span>
    <a href="#setting-expectations">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h2><p>The following is not a library, nor a declaration of intent to build a library. It&rsquo;s merely a design pattern
that I want to help popularize. After a year of use this system proved to be both easy to maintain and helpful
when writing and changing code. Errors related to faulty API expectations were rare thanks to this system. You
can get many of the benefits that I achieved by using GraphQL. But for systems that predate GraphQL or
situations where GraphQL feels inappropriate this can be your fall-back.</p>
<h2 id="what-i-ended-up-with" >What I Ended Up With
<span>
    <a href="#what-i-ended-up-with">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h2><p>So you want to request the data for the current user.</p>
<ol>
<li>First, get out the bespoke <code>request</code> function (only a dozen lines of runtime code).</li>
<li>Then get a handle on the API types.</li>
<li>Pass the <code>CurrentUser</code> endpoint type into <code>request</code>&rsquo;s type parameter.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">request</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@company/webapp/http&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">API</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@company/api/endpoints&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">request</span>&lt;<span style="color:#f92672">API.CurrentUser</span>&gt;({});
</span></span></code></pre></div><p>Already you&rsquo;ll be getting compiler errors! <code>API.CurrentUser</code>&rsquo;s method is of type &ldquo;get&rdquo; and you haven&rsquo;t
specified an HTTP method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">request</span>&lt;<span style="color:#f92672">API.CurrentUser</span>&gt;({ <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;get&#34;</span> });
</span></span></code></pre></div><p>Again a compiler error (thanks, TypeScript :D). <code>API.CurrentUser</code> has a path type of &ldquo;/user/me&rdquo; and
you haven&rsquo;t provided a path.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">request</span>&lt;<span style="color:#f92672">API.CurrentUser</span>&gt;({ <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/user/me&#34;</span> });
</span></span></code></pre></div><p>Success! This is a valid API request. And even better the type of <code>user</code> is <code>ApiResponse&lt;{ id: number, email: string, ...}&gt;</code>.</p>
<p><strong>Changing anything along the pipeline from the model to the view will automatically adjust the types and should
give compiler errors where the API has made a breaking change</strong>. New (whitelisted) fields on the user are automatically
shown in your front end code&rsquo;s IntelliSense.</p>
<p>Curious how it all works? Read on!</p>
<h2 id="implementation-part-1---models" >Implementation Part 1 - Models
<span>
    <a href="#implementation-part-1---models">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h2><p>The architecture of the app this was built for has a NextJS/React front-end, with a NestJS/TypeORM back-end.</p>
<p>Most of the data that gets chucked to the front end originated in the model layer. So if I&rsquo;m going to use models in the API I want their property&rsquo;s types propagated all the way to the front-end.</p>
<h3 id="requirements" >Requirements:
<span>
    <a href="#requirements">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h3><ol>
<li>A system to enumerate attribute names that get sent to NextJS</li>
<li>A system that does not require re-stating types</li>
</ol>
<h3 id="solution" >Solution:
<span>
    <a href="#solution">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h3><p>I can leverage TypeScript to allow for extracting a per-model type interface defined by just an array of model properties I want to share with the client. For a <code>User</code> that array would include things like <code>[&quot;id&quot;, &quot;email&quot;, &quot;firstName&quot;, &quot;lastName&quot;, ...]</code>. This requires some fancy type-level programming, but I&rsquo;ve already done the hard work for you. The trick is all in the signature of the function used to pluck out the corresponding values for <code>id</code>, <code>email</code> etc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">extractDTOAttrs</span>&lt;<span style="color:#f92672">This</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Attr</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">keyof</span> <span style="color:#a6e22e">This</span>&gt;(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">This</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">attrs</span>: <span style="color:#66d9ef">Attr</span>[]
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> { [<span style="color:#a6e22e">P</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">Attr</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">This</span>[<span style="color:#a6e22e">P</span>] <span style="color:#66d9ef">extends</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">infer</span> <span style="color:#a6e22e">Return</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">Return</span> : <span style="color:#66d9ef">This</span>[<span style="color:#a6e22e">P</span>] } {
</span></span></code></pre></div><p><sup>DTO here is jargon that means &ldquo;data-transfer-object&rdquo;. It&rsquo;s how the database record looks in JSON format.</sup></p>
<p>A call to this function looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">extractDTOAttrs</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;id&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;email&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;firstName&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;lastName&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>])
</span></span></code></pre></div><p>TypeScript has allowed us to lock down a lot of things here.</p>
<ul>
<li>The array of strings can only contain valid keys to <code>This</code> (the type of our model&rsquo;s <code>this</code> pointer)</li>
<li>The return type of <em>this specific <code>extractDTOAttrs</code> invokation</em> will be an interface with the keys as elements from the array, and each key&rsquo;s matching type pulled from the model&rsquo;s existing type definition.</li>
</ul>
<p>Here&rsquo;s a more complete excerpt from two TypeORM files:</p>
<p><code>@company/models/root.entity.ts</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CanBeDTO</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">toDTO</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">unknown</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">canBeDTO</span>(<span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">unknown</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">is</span> <span style="color:#a6e22e">CanBeDTO</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">value</span>[<span style="color:#e6db74">&#34;toDTO&#34;</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;function&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RootEntity</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">@PrimaryGeneratedColumn</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">id?</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">abstract</span> <span style="color:#a6e22e">toDTO</span>()<span style="color:#f92672">:</span> <span style="color:#66d9ef">unknown</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Pick only certain attributes from `this`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param this Model instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param attrs Whitelist of attributes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @returns DTO object.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">extractDTOAttrs</span>&lt;<span style="color:#f92672">This</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Attr</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">keyof</span> <span style="color:#a6e22e">This</span>&gt;(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">This</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">attrs</span>: <span style="color:#66d9ef">Attr</span>[]
</span></span><span style="display:flex;"><span>  )<span style="color:#f92672">:</span> { [<span style="color:#a6e22e">P</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">Attr</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">This</span>[<span style="color:#a6e22e">P</span>] <span style="color:#66d9ef">extends</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">infer</span> <span style="color:#a6e22e">Return</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">Return</span> : <span style="color:#66d9ef">This</span>[<span style="color:#a6e22e">P</span>] } {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">DTO</span>: <span style="color:#66d9ef">any</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">attr</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">attrs</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>[<span style="color:#a6e22e">attr</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">instanceof</span> <span style="color:#a6e22e">Promise</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">canBeDTO</span>(<span style="color:#a6e22e">value</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// No recursive calls, please.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Attribute </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">attr</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> can not be exported to a DTO`</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;function&#34;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">DTO</span>[<span style="color:#a6e22e">attr</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">bind</span>(<span style="color:#66d9ef">this</span>)();
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">DTO</span>[<span style="color:#a6e22e">attr</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">DTO</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>@company/models/user.entity.ts</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">@Entity</span>({ <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;user&#34;</span> })
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">RootEntity</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">@Column</span>({ <span style="color:#66d9ef">unique</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;citext&#34;</span> })
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">email</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">@Column</span>({ <span style="color:#a6e22e">nullable</span>: <span style="color:#66d9ef">true</span> })
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">firstName?</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">@Column</span>({ <span style="color:#a6e22e">nullable</span>: <span style="color:#66d9ef">true</span> })
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lastName?</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">toDTO() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">extractDTOAttrs</span>([
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;id&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;email&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;firstName&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;lastName&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ]);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This solution is generic enough that you should be able to use it with any ORM. Not just TypeORM.</p>
<p>Thanks to TypeScript&rsquo;s return type inference the type of <code>this.extractDTOAttrs([...])</code> becomes <code>User.toDTO()</code>&rsquo;s type as well.</p>
<h2 id="implementation-part-2---controllers" >Implementation Part 2 - Controllers
<span>
    <a href="#implementation-part-2---controllers">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h2><p>The end goal here is to get both the data and type for each model&rsquo;s DTO into the front end code. We have the types written automatically for us. We just need to pipe them through to the client.</p>
<h3 id="requirements-1" >Requirements:
<span>
    <a href="#requirements-1">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h3><ol>
<li>Get the type of <code>User.toDTO()</code> to a place where it can be accessed from the front end</li>
</ol>
<h3 id="solution-1" >Solution:
<span>
    <a href="#solution-1">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h3><p><code>@company/api/modules/user.controller.ts</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">@Controller</span>(<span style="color:#e6db74">&#34;user&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">@Get</span>(<span style="color:#e6db74">&#34;me&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">@UseGuards</span>(<span style="color:#a6e22e">AuthGuard</span>())
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">me</span>(<span style="color:#66d9ef">@Req</span>() <span style="color:#a6e22e">req</span>: <span style="color:#66d9ef">AuthdRequest</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;success&#34;</span>, <span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">req.user.toDTO</span>() };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><sup>The above code is from a NestJS back-end.</sup></p>
<p>Just with the code above TypeScript will automatically pipe through the type of <code>User.toDTO()</code> into the
return type of <code>UserController.me</code>. The full type will be:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserControllerMeMethod</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;success&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">email</span>: <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">firstName</span>: <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lastName</span>: <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The wrapper structure is called <code>SuccessResponse&lt;T&gt;</code>. So the type is, more succinctly, <code>SuccessResponse&lt;ReturnType&lt;User[&quot;toDTO&quot;]&gt;&gt;</code>.</p>
<p>We <em>could</em> extract this type from the controller and import it into the front end without any other supporting code. But that would require the front-end to reference specific back-end files which increases coupling. So as an alternative I&rsquo;ve defined an endpoints file in the root of the NestJS project. If we only export endpoint definitions in this file we can grab the full API definition with one clean import:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">API</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@company/api/endpoints&#34;</span>;
</span></span></code></pre></div><p>Here&rsquo;s what the endpoint spec looks like for <code>/user/me</code>:</p>
<p><code>@company/api/endpoints</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Get attributes on currently logged in user.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CurrentUser</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetEndpoint</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;/user/me&#34;</span>, <span style="color:#66d9ef">never</span>, <span style="color:#a6e22e">ResponseDataType</span>&lt;<span style="color:#f92672">typeof</span> <span style="color:#a6e22e">UserController</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#a6e22e">me</span><span style="color:#960050;background-color:#1e0010">&#34;</span>&gt;<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...more endpoints...
</span></span></span></code></pre></div><p>You can even parameterize the paths with templated string types. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Widget</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetEndpoint</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">`/widget/</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">number</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#66d9ef">never</span>, <span style="color:#a6e22e">ResponseDataType</span>&lt;<span style="color:#f92672">typeof</span> <span style="color:#a6e22e">WidgetController</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#a6e22e">get</span><span style="color:#960050;background-color:#1e0010">&#34;</span>&gt;<span style="color:#f92672">&gt;</span>;
</span></span></code></pre></div><p>When used you will only be able to specify paths like <code>/widget/1</code>. But any non-numeric suffixes - <code>/widget/foo</code> - will result in a compiler error. You could also parameterize with a string union or any other primitive union.</p>
<p>The only parts of the API spec that duplicate information are the HTTP verb and path. But those are unlikely to change very often - if ever.</p>
<p>And here are the supporting types:</p>
<p><code>@company/api/types</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ErrorCodeType</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NOT_FOUND&#34;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;INTERNAL_SERVER_ERROR&#34;</span>; <span style="color:#75715e">// Add error codes as needed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// API response structure
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SuccessResponse</span>&lt;<span style="color:#f92672">T</span>&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;success&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">T</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ErrorResponse</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;error&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">errorCode</span>: <span style="color:#66d9ef">ErrorCodeType</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">message?</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">details</span><span style="color:#f92672">?:</span> { [<span style="color:#a6e22e">key</span>: <span style="color:#66d9ef">string</span>]<span style="color:#f92672">:</span> <span style="color:#66d9ef">unknown</span> };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ApiResponse</span>&lt;<span style="color:#f92672">T</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">SuccessResponse</span>&lt;<span style="color:#f92672">T</span>&gt; <span style="color:#f92672">|</span> <span style="color:#a6e22e">ErrorResponse</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Endpoint types
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HttpVerb</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;get&#34;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;post&#34;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;patch&#34;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;put&#34;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;delete&#34;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;options&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Endpoint</span>&lt;<span style="color:#f92672">Verb</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">HttpVerb</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Path</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Params</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">ResponseData</span>&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">verb</span>: <span style="color:#66d9ef">Verb</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">path</span>: <span style="color:#66d9ef">Path</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">params</span>: <span style="color:#66d9ef">Params</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">responseData</span>: <span style="color:#66d9ef">ResponseData</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GetEndpoint</span>&lt;<span style="color:#f92672">Path</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Params</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">ResponseData</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">Endpoint</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#a6e22e">Path</span>, <span style="color:#a6e22e">Params</span>, <span style="color:#a6e22e">ResponseData</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">PostEndpoint</span>&lt;<span style="color:#f92672">Path</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Params</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Body</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">ResponseData</span>&gt;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Endpoint</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;post&#34;</span>, <span style="color:#a6e22e">Path</span>, <span style="color:#a6e22e">Params</span>, <span style="color:#a6e22e">ResponseData</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">body</span>: <span style="color:#66d9ef">Body</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">PatchEndpoint</span>&lt;<span style="color:#f92672">Path</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Params</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Body</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">ResponseData</span>&gt;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Endpoint</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;patch&#34;</span>, <span style="color:#a6e22e">Path</span>, <span style="color:#a6e22e">Params</span>, <span style="color:#a6e22e">ResponseData</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">body</span>: <span style="color:#66d9ef">Body</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">PutEndpoint</span>&lt;<span style="color:#f92672">Path</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Params</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Body</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">ResponseData</span>&gt;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Endpoint</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;put&#34;</span>, <span style="color:#a6e22e">Path</span>, <span style="color:#a6e22e">Params</span>, <span style="color:#a6e22e">ResponseData</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">body</span>: <span style="color:#66d9ef">Body</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DeleteEndpoint</span>&lt;<span style="color:#f92672">Path</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Params</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">ResponseData</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">Endpoint</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;delete&#34;</span>, <span style="color:#a6e22e">Path</span>, <span style="color:#a6e22e">Params</span>, <span style="color:#a6e22e">ResponseData</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Below here is code to cleanly extract the return type from a controller method.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ClassType</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> (...<span style="color:#a6e22e">args</span>: <span style="color:#66d9ef">any</span>[]) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">any</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UnPromisify</span>&lt;<span style="color:#f92672">Outer</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">Outer</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">infer</span> <span style="color:#a6e22e">Inner</span>&gt; <span style="color:#f92672">?</span> <span style="color:#a6e22e">Inner</span> : <span style="color:#66d9ef">Outer</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UnResponsify</span>&lt;<span style="color:#f92672">Outer</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">Outer</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">SuccessResponse</span>&lt;<span style="color:#f92672">infer</span> <span style="color:#a6e22e">Data</span>&gt; <span style="color:#f92672">?</span> <span style="color:#a6e22e">Data</span> : <span style="color:#66d9ef">never</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ResponseDataType</span><span style="color:#f92672">&lt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Controller</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">ClassType</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Method</span> <span style="color:#66d9ef">extends</span> <span style="color:#66d9ef">keyof</span> <span style="color:#a6e22e">InstanceType</span>&lt;<span style="color:#f92672">Controller</span>&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">UnResponsify</span>&lt;<span style="color:#f92672">UnPromisify</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">ReturnType</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">InstanceType</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">Controller</span>&gt;[<span style="color:#a6e22e">Method</span>]<span style="color:#f92672">&gt;&gt;&gt;</span>;
</span></span></code></pre></div><h2 id="implementation-part-3---views" >Implementation Part 3 - Views
<span>
    <a href="#implementation-part-3---views">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h2><p>Okay, so we have models that automatically define types for their DTO incarnations. And we also have a
back-end that preserves these types (and any other types defined in the controllers themselves). So with
that all set in place we need to do a few more things.</p>
<h3 id="requirements-2" >Requirements:
<span>
    <a href="#requirements-2">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h3><ol>
<li>Convert the response types into their post JSON serialization/de-serialization versions.</li>
<li>Unpack the Endpoint types in front end code.</li>
</ol>
<p><sup>An Endpoint type (such as <code>GetEndpoint</code>, <code>PostEndpoint</code>, etc.) wraps up a Verb type, Path type, Response type, and more. Being able to see each of those components one at a time is helpful.</sup></p>
<h3 id="solution-2" >Solution:
<span>
    <a href="#solution-2">
        <svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg>
    </a>
</span>
</h3><p>Requirement 1 may have surprised you. What conversion needs to be done? Why would a type look different after converting to/from JSON? We&rsquo;re only sending JSON-serializable types over the network, right? Yes - but not all JSON-serializable types deserialize back to their original type.</p>
<p>Take, for example, a <code>Date</code>. We will often want to include a <code>createdAt</code> or <code>updatedAt</code> timestamp in DTOs.
You <em>can</em> serialize a <code>Date</code>, but <code>JSON.stringify({ date: new Date() })</code> results in <code>{ &quot;date&quot;: &quot;2022-05-15T05:21:07.324Z&quot; }</code>. The <code>Date</code> has become a string! And when de-serializing why would the front-end know that this string in particular should become a <code>Date</code>? It doesn&rsquo;t.</p>
<p>The intention here is not to change this behavior. Only to track it accurately. We don&rsquo;t want a type in the front-end that tells you there&rsquo;s a <code>Date</code> field in a DTO. And then at run time it&rsquo;s actually a string. That&rsquo;s exactly the kind of error we&rsquo;re using TypeScript to prevent!</p>
<p>The solution is to define a recursive type, <code>JSONSerialized</code>, that walks through an object or array. The context here is front-end code reading back-end types.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Converts a type into its post JSON serialization/de-serialization version.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">JSONSerialized</span>&lt;<span style="color:#f92672">T</span>&gt; <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// We first check if we&#39;re looking at a primitive type. Primitives will be passed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// through untouched by `JSON.parse(JSON.stringify(...))`, so `JSONSerialized` replicates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// that behavior. The exact `T` type is output instead of `number` or `string` in case
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// the type is actually a union (ex: &#34;foo&#34; | &#34;bar&#34;). This way the union is preserved.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#66d9ef">number</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">T</span> :
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">T</span> :
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#66d9ef">boolean</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">T</span> :
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If we aren&#39;t looking at a primitive, then we&#39;ll next check if we&#39;re working with an
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// array. If so we convert the array&#39;s element type using a recursive type call.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">extends</span> (<span style="color:#66d9ef">infer</span> <span style="color:#a6e22e">Elem</span>)[] <span style="color:#f92672">?</span> <span style="color:#a6e22e">JSONSerialized</span>&lt;<span style="color:#f92672">Elem</span>&gt;[] <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Here&#39;s the magic that takes care of `Date`s. Some types have a `toJSON` function.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// `JSON.stringify` will call this function if it doesn&#39;t already know what to do with
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// a value. By using `infer` we can dynamically extract the return type of a `toJSON()`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// as defined on ANY type - including `Date.toJSON`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">extends</span> { <span style="color:#a6e22e">toJSON</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">infer</span> <span style="color:#a6e22e">Return</span> } <span style="color:#f92672">?</span> <span style="color:#a6e22e">Return</span> <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Lastly, check if we&#39;re working with an Object and if so, iterate through its
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// key/value pairs - sending each value into a recursive call to `JSONSerialized`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">extends</span> { [<span style="color:#a6e22e">Key</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">keyof</span> <span style="color:#a6e22e">T</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">T</span>[<span style="color:#a6e22e">Key</span>] } <span style="color:#f92672">?</span> { [<span style="color:#a6e22e">Key</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">keyof</span> <span style="color:#a6e22e">T</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">JSONSerialized</span>&lt;<span style="color:#f92672">T</span><span style="color:#960050;background-color:#1e0010">[</span><span style="color:#a6e22e">Key</span><span style="color:#960050;background-color:#1e0010">]</span>&gt; } <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">never</span>;
</span></span></code></pre></div><p>We can take care of requirement 2 with the following types. Each extractor type uses the generic endpoint type, <code>Endpoint</code>, along with TypeScript&rsquo;s <code>infer</code> keyword to extract just one of the type parameters.</p>
<p><code>ResponseDataType</code> uses our buddy <code>JSONSerialized</code> to revise the back-end type for use in the front-end.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">ApiResponse</span>, <span style="color:#a6e22e">Endpoint</span>, <span style="color:#a6e22e">PatchEndpoint</span>, <span style="color:#a6e22e">PostEndpoint</span>, <span style="color:#a6e22e">PutEndpoint</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;@company/api/types&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Types for pulling apart an endpoint definition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">VerbType</span>&lt;<span style="color:#f92672">T</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Endpoint</span>&lt;<span style="color:#f92672">infer</span> <span style="color:#a6e22e">Verb</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span>&gt; <span style="color:#f92672">?</span> <span style="color:#a6e22e">Verb</span> : <span style="color:#66d9ef">never</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PathType</span>&lt;<span style="color:#f92672">T</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Endpoint</span>&lt;<span style="color:#f92672">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">infer</span> <span style="color:#a6e22e">Path</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span>&gt; <span style="color:#f92672">?</span> <span style="color:#a6e22e">Path</span> : <span style="color:#66d9ef">never</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BodyType</span>&lt;<span style="color:#f92672">T</span>&gt; <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">PostEndpoint</span>&lt;<span style="color:#f92672">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">infer</span> <span style="color:#a6e22e">Body</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span>&gt; <span style="color:#f92672">?</span> <span style="color:#a6e22e">Body</span> :
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">PatchEndpoint</span>&lt;<span style="color:#f92672">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">infer</span> <span style="color:#a6e22e">Body</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span>&gt; <span style="color:#f92672">?</span> <span style="color:#a6e22e">Body</span> :
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">PutEndpoint</span>&lt;<span style="color:#f92672">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">infer</span> <span style="color:#a6e22e">Body</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span>&gt; <span style="color:#f92672">?</span> <span style="color:#a6e22e">Body</span> :
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">never</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ParamsType</span>&lt;<span style="color:#f92672">T</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Endpoint</span>&lt;<span style="color:#f92672">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">infer</span> <span style="color:#a6e22e">Params</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span>&gt; <span style="color:#f92672">?</span> <span style="color:#a6e22e">Params</span> : <span style="color:#66d9ef">never</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ResponseDataType</span>&lt;<span style="color:#f92672">T</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Endpoint</span>&lt;<span style="color:#f92672">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">infer</span> <span style="color:#a6e22e">Data</span>&gt; <span style="color:#f92672">?</span> <span style="color:#a6e22e">JSONSerialized</span>&lt;<span style="color:#f92672">Data</span>&gt; <span style="color:#f92672">:</span> <span style="color:#66d9ef">never</span>;
</span></span></code></pre></div><p>Now we just need a nice function that makes use of these types. Below we define <code>request&lt;T&gt;()</code> such that
only valid API requests can be made. This is done by locking down the <code>method</code>, <code>url</code>, <code>params</code> and
<code>data</code> fields in the <code>RequestOptions</code> type.</p>
<p><code>@company/webapp/http.ts</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">axios</span>, { <span style="color:#a6e22e">AxiosRequestConfig</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;axios&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">axios</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">timeout</span>: <span style="color:#66d9ef">30000</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">RequestOptions</span>&lt;<span style="color:#f92672">T</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">Endpoint</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span>&gt;<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AxiosRequestConfig</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">method</span>: <span style="color:#66d9ef">VerbType</span>&lt;<span style="color:#f92672">T</span>&gt;;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">url</span>: <span style="color:#66d9ef">PathType</span>&lt;<span style="color:#f92672">T</span>&gt;;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">params?</span>: <span style="color:#66d9ef">ParamsType</span>&lt;<span style="color:#f92672">T</span>&gt;;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">data?</span>: <span style="color:#66d9ef">BodyType</span>&lt;<span style="color:#f92672">T</span>&gt;;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Make a type-checked api request.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param options Request options
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @returns Response payload
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">request</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> &lt;<span style="color:#f92672">T</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">Endpoint</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span>&gt;<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">options</span>: <span style="color:#66d9ef">RequestOptions</span>&lt;<span style="color:#f92672">T</span>&gt;
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">ApiResponse</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">ResponseDataType</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">T</span>&gt;<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">request</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Content-Type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">withCredentials</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    ...<span style="color:#a6e22e">options</span>,
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">apiResponse</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">data</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">ApiResponse</span>&lt;<span style="color:#f92672">ResponseDataType</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">T</span>&gt;<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">apiResponse</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;error&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">apiResponse</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
        </div>
        


<div class="post-info">
    
        <div class="post-date dt-published">2022-05-14</div>
    

    <a class="post-hidden-url u-url" href="https://danangell.com/blog/posts/type-level-api-client/">https://danangell.com/blog/posts/type-level-api-client/</a>
    <a href="https://danangell.com/blog" class="p-name p-author post-hidden-author h-card" rel="me">Daniel Angell</a>


    <div class="post-taxonomies">
        
            
                <ul class="post-tags">
                    
                        
                        <li><a href="https://danangell.com/blog/tags/programming/">#programming</a></li>
                    
                        
                        <li><a href="https://danangell.com/blog/tags/typescript/">#typescript</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>

    

    

    
        







    

        </main>
        
            <footer class="common-footer">
    
    

    <div class="common-footer-bottom">
        
        <div class="copyright">
            <p> Daniel Angell, 2023<br>
                
            </p>
        </div>
    </div>

    <p class="h-card vcard">

    <a href=https://danangell.com/blog class="p-name u-url url fn" rel="me">Daniel Angell</a> 

    

    
</p> 
</footer>
        
    </div>
</body>
</html>
